<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Good Morning {{ recipient_name }}! - {{ date }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Reset & Base Styles */
        * { margin: 0; padding: 0; }
        body {
            width: 100% !important;
            margin: 0 !important;
            padding: 10px !important;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            background-color: #efcfe3;
            font-family: 'Merriweather', serif; /* Base font */
            line-height: 1.5; /* Base line height */
            color: #444;
            font-size: 14px; /* Define a base font size for resets later */
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            border: 0;
            -ms-interpolation-mode: bicubic;
        }

        /* Bento Grid Container */
        .bento-container {
            max-width: 700px;
            margin: 0 auto;
            background-color: #fff;
            border: 2px solid #e27396;
            border-radius: 8px; /* Inconsistent support */
            padding: 8px;
            text-align: center;
        }

        /* Bento Row - Use font-size: 0 trick for spacing */
        .bento-row {
            font-size: 0; /* Collapses whitespace between inline-block children */
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
        }
        .bento-row:last-child {
            margin-bottom: 0;
        }


        /* Bento Column - Using inline-block */
        .bento-col {
            display: inline-block;
            vertical-align: top;
            text-align: left;
            font-size: 14px; /* IMPORTANT: Reset font size from parent */
            line-height: 1.5; /* IMPORTANT: Reset line height from parent */
            /* --- HEIGHTS WILL NOT MATCH ACROSS COLUMNS --- */
        }

        /* Column Widths - Use exact percentages with font-size: 0 */
         .bento-col-60 {
            width: 60%;
         }

         .bento-col-40 {
            width: 40%;
         }
         /* --- No padding/border on these column divs --- */

        /* Bento Grid Items */
        .bento-item {
            background-color: #FFFFFF;
            border-radius: 6px; /* Inconsistent support */
            padding: 15px;
            border: 1px solid rgba(226, 115, 150, 0.5);
            margin-bottom: 8px; /* Vertical gap BETWEEN items within a single column */
            /* --- HEIGHT WILL ADJUST TO CONTENT ONLY --- */
        }
        /* Remove margin from last item within a column */
        .bento-col > .bento-item:last-child {
             margin-bottom: 0;
        }


        /* Cell Themes */
        .cell-pink { background-color: #e27396; border-color: #e27396; color: #fff; }
        .cell-lightpink { background-color: #ea9ab2; border-color: #e27396; color: #fff; }
        .cell-soft { background-color: #efcfe3; border-color: #ea9ab2; }
        .cell-green { background-color: #eaf2d7; border-color: #eaf2d7; }
        .cell-blue { background-color: #b3dee2; border-color: #b3dee2; }

        /* Headers */
        h1, h2, .item-title { font-family: 'Oswald', sans-serif; font-weight: 700; margin-bottom: 10px; line-height: 1.2; text-align: center; }
        .cell-pink h1, .cell-pink h2, .cell-lightpink h1, .cell-lightpink h2 { color: #fff; }
        .cell-soft h1, .cell-soft h2, .cell-green h1, .cell-green h2, .cell-blue h1, .cell-blue h2 { color: #e27396; }
        h1 { font-size: 22px; border-bottom: 1px solid rgba(255, 255, 255, 0.4); padding-bottom: 6px; margin-bottom: 8px; }
        .cell-soft h1, .cell-green h1, .cell-blue h1 { border-bottom: 1px solid rgba(226, 115, 150, 0.4); }
        h2 { font-size: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding-bottom: 4px; margin-bottom: 10px; }
        .cell-soft h2, .cell-green h2, .cell-blue h2 { border-bottom: 1px solid rgba(226, 115, 150, 0.3); }
        h2 .icon { margin-right: 6px; display: inline-block; vertical-align: middle; }

        /* Typography */
        p { margin: 0 0 8px 0; }
        p:last-child { margin-bottom: 0; }
        .text-center { text-align: center; }
        .header-subtitle { font-size: 12px; text-align: center; margin-bottom: 10px; }
        .header-quote { font-style: italic; font-size: 14px; margin: 10px auto 0; text-align: center; max-width: 95%; }
        .header-quote cite { display: block; text-align: right; font-size: 12px; font-style: normal; margin-top: 4px; }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 12px; line-height: 1.4; }
        .text-xxs { font-size: 11px; line-height: 1.3; }
        .light-text { color: rgba(255, 255, 255, 0.8); }
        .cell-soft .light-text, .cell-green .light-text, .cell-blue .light-text { color: rgba(226, 115, 150, 0.7); }

        /* Solar - Stacking vertically */
        .solar-info { font-size: 13px; margin-bottom: 8px; }
        .solar-info strong { display: block; margin-bottom: 2px; }
        .solar-info strong .emoji { margin-right: 5px; }
        .solar-info span { display: block; text-align: left; }

        /* Word of Day */
        .wod-word { font-family: 'Oswald', sans-serif; font-size: 16px; color: #e27396; text-transform: uppercase; display: block; margin-bottom: 2px; text-align: center; }
        .cell-pink .wod-word, .cell-lightpink .wod-word { color: #fff; }
        .wod-pos { text-align: center; display: block; margin-bottom: 6px; font-size: 11px; }

        /* Scrollable Containers */
        .scroll-container { overflow-y: auto; max-height: 150px; margin-bottom: 5px; padding-right: 5px; }

        /* Recipe */
        .recipe-image-container { text-align: center; margin-bottom: 10px; }
        .recipe-image { max-width: 90%; height: auto; margin: 0 auto; border: 1px solid #ea9ab2; border-radius: 4px; }
        .recipe-list { font-size: 11px; line-height: 1.3; padding-left: 18px; margin: 8px 0; }
        .recipe-list li { margin-bottom: 5px; }
        .recipe-source-link { display: block; text-align: center; font-size: 11px; margin-top: 8px; }

        /* Research Papers */
        .paper-list { margin: 0; padding: 0; list-style: none; }
        .paper-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed rgba(226, 115, 150, 0.2); }
        .paper-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .paper-title { font-weight: bold; font-size: 13px; margin-bottom: 3px; color: #e27396; display: block; }
        .cell-pink .paper-title, .cell-lightpink .paper-title { color: #fff; }
        .paper-abstract { font-size: 12px; margin-bottom: 3px; line-height: 1.4; }
        .paper-meta { font-size: 10px; }

        /* Restaurant List - Float for image */
        .resto-list { margin: 0; padding: 0; list-style: none; }
        .resto-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed rgba(226, 115, 150, 0.2); overflow: hidden; clear: both; }
        .resto-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .resto-photo { width: 60px; height: 60px; margin-right: 8px; border-radius: 4px; border: 1px solid #ea9ab2; float: left; }
        .resto-details { overflow: hidden; display: block; }
        .resto-name { font-weight: bold; font-size: 14px; margin-bottom: 2px; display: block; color: #e27396; }
        .cell-pink .resto-name, .cell-lightpink .resto-name { color: #fff; }
        .resto-address { font-size: 11px; line-height: 1.3; margin-bottom: 2px; }
        .cell-pink .resto-address, .cell-lightpink .resto-address { color: rgba(255, 255, 255, 0.8); }
        .cell-soft .resto-address, .cell-green .resto-address, .cell-blue .resto-address { color: rgba(226, 115, 150, 0.7); }

        /* Rating Line - Fix for stars */
        .resto-rating-line { font-size: 11px; line-height: 1.2; margin-bottom: 3px; }
        .stars-container {
            display: inline-block; /* Use inline-block */
            vertical-align: middle; /* Align with adjacent text */
            white-space: nowrap; /* CRITICAL: Prevent wrapping stars */
        }
        .resto-rating-stars { /* Styles specific to the stars if needed */
            color: #e27396;
            letter-spacing: 1px; /* Optional: Adjust spacing between stars */
        }
        .cell-pink .resto-rating-stars, .cell-lightpink .resto-rating-stars { color: #ffdb58; }
        .resto-rating-line .light-text { display: inline-block; vertical-align: middle; margin-left: 3px; } /* Align text next to stars */


        /* Reviews - Fix for stars */
        .resto-reviews h4 { font-family: 'Oswald', sans-serif; font-weight: 400; font-size: 12px; color: #e27396; margin: 6px 0 4px; padding-top: 4px; border-top: 1px dotted rgba(226, 115, 150, 0.2); text-transform: uppercase; }
        .cell-pink .resto-reviews h4, .cell-lightpink .resto-reviews h4 { color: #fff; border-top: 1px dotted rgba(255, 255, 255, 0.3); }
        .resto-reviews ul { list-style: none; margin: 0; padding: 0; font-size: 11px; }
        .resto-reviews li { margin-bottom: 4px; }
        .reviewer-line { margin-bottom: 2px; }
        .reviewer { font-weight: bold; display: inline; }
        .review-stars {
            display: inline-block; /* Use inline-block */
            vertical-align: middle; /* Align with reviewer name */
            white-space: nowrap; /* CRITICAL: Prevent wrapping stars */
            margin-left: 4px;
            color: #e27396;
            letter-spacing: 1px; /* Optional: Adjust spacing */
        }
        .cell-pink .review-stars, .cell-lightpink .review-stars { color: #ffdb58; }
        .review-text { font-style: italic; color: #555; display: block; }
        .cell-pink .review-text, .cell-lightpink .review-text { color: rgba(255, 255, 255, 0.9); }

        /* Cat Image */
        .cat-image-container { text-align: center; margin-top: 5px; }
        .cat-image { width: 100%; max-width: 100%; height: auto; border-radius: 5px; border: 1px solid #ea9ab2; }


        /* Footer */
        .footer { text-align: center; padding: 15px 10px 10px; border-top: 2px solid #ea9ab2; color: #e27396; font-size: 12px; width: auto; }
        .footer p { margin-bottom: 0; }

        a { color: #e27396; text-decoration: none; }
        .cell-pink a, .cell-lightpink a { color: #fff; text-decoration: underline; }

        /* Media Queries for Responsive Stacking */
        @media screen and (max-width: 650px) {
            .bento-col,
            .bento-col-60,
            .bento-col-40 {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                margin-bottom: 8px !important;
                /* Reset font-size if inheriting 0 from parent */
                font-size: 14px !important;
                line-height: 1.5 !important;
            }
            .bento-row > .bento-col:last-child { margin-bottom: 0 !important; }
            .bento-item { margin-bottom: 8px !important; }
            .bento-col > .bento-item:last-child { margin-bottom: 0 !important; }

            h1 { font-size: 20px !important; }
            h2 { font-size: 15px !important; }
            .scroll-container { max-height: 180px !important; }
            .paper-list, .recipe-list, .resto-list { font-size: 12px !important; }
        }
    </style>
</head>

<body bgcolor="#efcfe3" style="background-color: #efcfe3;">
    <!-- Bento Grid Container -->
    <div class="bento-container">

        <!-- Row 1: Header (60%) | Solar & Cat (40%) -->
        <div class="bento-row">
            <div class="bento-col bento-col-60">
                <div class="bento-item cell-lightpink">
                    <!-- Content -->
                    <h1>Good Morning {{ recipient_name }}!!!</h1>
                    <p class="header-subtitle">{{ datetime }}</p>
                    <p class="header-quote">
                        <em>{{ zen_quote.quote }}</em>
                        <cite>— {{ zen_quote.author }}</cite>
                    </p>
                    <!-- NOTE: This item's height is determined by this content -->
                </div>
            </div><div class="bento-col bento-col-40">
                <!-- Solar Schedule -->
                <div class="bento-item cell-blue" style="margin-bottom: 8px;">
                    <h2><span class="icon">☀️</span> Perfect Timing Guide</h2>
                    <!-- ... solar content ... -->
                     <div class="solar-info"><strong><span class="emoji">🌅</span> Sunrise:</strong> <span>{{ solar_schedule.sunrise }}</span></div>
                     <div class="solar-info"><strong><span class="emoji">✨</span> Best Photo Light:</strong> <span>{{ solar_schedule.golden_hour }}</span></div>
                     <div class="solar-info"><strong><span class="emoji">🌇</span> Sunset:</strong> <span>{{ solar_schedule.sunset }}</span></div>
                </div>
                <!-- Daily Cat -->
                <div class="bento-item cell-soft">
                    <h2><span class="icon">🐾</span> Today's Cute Cat</h2>
                    <div class="cat-image-container">
                        <img src="{{ cat_gif }}" alt="Cat of the day" class="cat-image">
                    </div>
                </div>
                 <!-- NOTE: This column's height is determined by these TWO items + margin -->
            </div>
        </div> <!-- End Row 1 -->

        <!-- Row 2: Research papers (60%) | Word, Fact, Horoscope stacked (40%) -->
        <div class="bento-row">
            <div class="bento-col bento-col-60">
                <div class="bento-item cell-green">
                    <!-- Research Content -->
                     <h2><span class="icon">🔭</span> Latest Research: {{ arxiv_query | capitalize }}</h2>
                     {% if arxiv_papers %}
                     <ul class="paper-list">
                         {% for paper in arxiv_papers[:3] %}
                         <li class="paper-item">
                             <span class="paper-title">{{ paper.title }}</span>
                             <div class="scroll-container"><p class="paper-abstract">{{ paper.abstract }}</p></div>
                             <p class="paper-meta"><span class="light-text">{{ paper.published }}</span> | <a href="{{ paper.pdf_link }}" target="_blank">PDF</a></p>
                         </li>
                         {% endfor %}
                     </ul>
                     {% else %}
                     <p class="light-text text-center">No new papers found for "{{ arxiv_query }}".</p>
                     {% endif %}
                     <!-- NOTE: Height determined by this content -->
                </div>
            </div><div class="bento-col bento-col-40">
                <!-- Word of the Day -->
                <div class="bento-item cell-pink" style="margin-bottom: 8px;">
                     <h2><span class="icon">📖</span> Word of the Day</h2>
                     <strong class="wod-word">{{ wod.word }}</strong>
                     <span class="wod-pos light-text">({{ wod.part_of_speech }})</span>
                     <p class="text-sm">{{ wod.definition }}</p>
                </div>
                <!-- Interesting Fact -->
                <div class="bento-item cell-blue" style="margin-bottom: 8px;">
                     <h2><span class="icon">💡</span> Today's Interesting Fact</h2>
                     <p class="text-sm">{{ interesting_fact }}</p>
                </div>
                <!-- Horoscope -->
                <div class="bento-item cell-soft">
                     <h2><span class="icon">✨</span> {{ horoscope.sign }} Horoscope</h2>
                     <p class="text-xs">{{ horoscope.prediction }}</p>
                     <p class="light-text text-xxs text-center">{{ horoscope.date }}</p>
                </div>
                 <!-- NOTE: Height determined by these THREE items + margins -->
            </div>
        </div> <!-- End Row 2 -->

        <!-- Row 3: Recipe (40%) | Nearby restaurants (60%) -->
        <div class="bento-row">
            <div class="bento-col bento-col-40">
                <div class="bento-item cell-lightpink">
                    <!-- Recipe Content -->
                    <h2><span class="icon">🍳</span> Recipe of the Day</h2>
                    <p class="text-center text-sm"><strong>{{ recipe.name }}</strong></p>
                    <a href="{{ recipe.source_url or '#' }}" target="_blank" class="recipe-image-container">{% if recipe.image_url %}<img src="{{ recipe.image_url }}" alt="Image of {{ recipe.name }}" class="recipe-image">{% endif %}</a>
                    <div class="scroll-container">
                        <ol class="recipe-list">
                            {% set instructions_list = recipe.instructions.splitlines() %}
                            {% for instruction in instructions_list %}{% if instruction.strip() %}<li>{{ instruction.strip() }}</li>{% endif %}{% endfor %}
                        </ol>
                    </div>
                    {% if recipe.source_url %}<a href="{{ recipe.source_url }}" target="_blank" class="recipe-source-link">View Full Recipe</a>{% endif %}
                    <!-- NOTE: Height determined by this content -->
                </div>
            </div><div class="bento-col bento-col-60">
                <div class="bento-item cell-green">
                    <!-- Restaurant Content -->
                    <h2><span class="icon">🗺️</span> Nearby Places to Explore</h2>
                    {% if restaurants %}
                    <ul class="resto-list">
                        {% for restaurant in restaurants[:3] %}
                        <li class="resto-item">
                            <img src="{% if restaurant.photo_base64 %}data:image/jpeg;base64,{{ restaurant.photo_base64 }}{% else %}https://via.placeholder.com/60x60.png?text=IMG{% endif %}" alt="" class="resto-photo">
                            <div class="resto-details">
                                <span class="resto-name">{{ restaurant.name }}</span>
                                <div class="resto-rating-line">
                                    <span class="stars-container"> <!-- Use span -->
                                        <span class="resto-rating-stars"> <!-- Inner span for specific styling -->
                                            {% set r = restaurant.rating|default(0)|round|int %}{% for i in range(r) %}⭐{% endfor %}{% for i in range(5-r) %}<span style="opacity: 0.3;">⭐</span>{% endfor %}
                                        </span>
                                    </span>
                                    <span class="light-text"> ({{ restaurant.rating|round(1) if restaurant.rating else 'N/A' }}) {{ restaurant.user_ratings_total or '?' }} ratings</span>
                                </div>
                                <p class="resto-address">{{ restaurant.address }}</p>
                                {% if restaurant.reviews %}
                                <div class="resto-reviews">
                                    <h4>Reviews:</h4>
                                    <div class="scroll-container">
                                        <ul>
                                            {% for review in restaurant.reviews %}
                                            <li>
                                                <div class="reviewer-line">
                                                    <span class="reviewer">{{ review.reviewer_name or 'Anon' }}:</span>
                                                    <span class="review-stars"> <!-- Use span -->
                                                        {% set rr = review.rating|default(0)|round|int %}{% for i in range(rr) %}⭐{% endfor %}{% for i in range(5-rr) %}<span style="opacity: 0.3;">⭐</span>{% endfor %}
                                                    </span>
                                                </div>
                                                <span class="review-text">"{{ review.text }}"</span>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="light-text text-center">No matching places found nearby.</p>
                    {% endif %}
                     <!-- NOTE: Height determined by this content -->
                </div>
            </div>
        </div> <!-- End Row 3 -->

        <!-- Footer -->
        <div class="bento-row">
            <div class="bento-col" style="width: 100%;">
                <div class="footer">
                    <p>Have a wonderful day!</p>
                </div>
            </div>
        </div> <!-- End Footer Row -->

    </div> <!-- End Bento Container -->
</body>
</html>